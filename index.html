<!doctype html>
<html>
  <head>
    <script type="text/javascript" src="webgl-debug.js"></script>
    <script type="text/javascript" src="require.js"></script>
    <script type="text/javascript" src="remnant.js"></script>


    <!-- SHADERS -->
    <script id="shader-main_frag" type="x-shader/x-fragment">
      #ifdef GL_ES
        precision highp float;
      #endif

      #define hasTexture $hasTexture
      #define hasCrop $hasCrop

      uniform float time;
      varying vec4 vColor;

      #if hasTexture
        varying vec2 vTextureCoord;
        uniform sampler2D uSampler;
        #if hasCrop
          uniform vec4 uCropSource;
        #endif
      #endif

      void main(void) {
        #if hasTexture
          #if hasCrop
            gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.x * uCropSource.z, vTextureCoord.y * uCropSource.w) + uCropSource.xy);
          #else
            gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.x, vTextureCoord.y));
          #endif
        #else
          gl_FragColor = vColor;
        #endif
      }
    </script>

    <script id="shader-main_vert" type="x-shader/x-vertex">
      #define hasTexture $hasTexture

      attribute vec4 aVertexPosition;

      #if hasTexture
        varying vec2 vTextureCoord;
      #endif

      uniform vec4 uColor;
      uniform mat3 uTransforms[$depth];

      varying vec4 vColor;

      const mat4 pMatrix = mat4($w, 0, 0, 0, 0, $h, 0, 0, 0, 0, 1.0, 1.0, -1.0, 1.0, 0, 0);

      mat3 crunchStack(void) {
        mat3 result = uTransforms[0];
        for (int i = 1; i < $depth; i++) {
          result = uTransforms[i] * result;
        }
        return result;
      }

      void main(void) {
        vec3 position =  crunchStack() * vec3(aVertexPosition.x, aVertexPosition.y, 1.0);
        gl_Position = pMatrix * vec4(position, 1.0);
        vColor = uColor;
        #if hasTexture
          vTextureCoord = aVertexPosition.zw;
        #endif
      }
    </script>
  </head>
</html>
